<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>好困俱乐部-陪玩端（含管理员）</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "微软雅黑", "黑体", sans-serif;
            -webkit-user-select: none;
            user-select: none;
        }
        body {
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 20px;
            background-image: radial-gradient(circle at center, #1a0a2c 0%, #0a0218 100%);
            margin: 0;
        }
        .main-container {
            width: 100%;
            max-width: 400px;
            background-color: #0a0218;
            border: 2px solid #ff00ff;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 0 15px #ff00ff, 0 0 30px #00ffff, inset 0 0 10px #ff00ff;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .main-container::before {
            content: "";
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            background: linear-gradient(45deg, #ff00ff, #00ffff, #ff00ff);
            border-radius: 22px;
            z-index: -1;
            animation: neonRotate 3s linear infinite;
            opacity: 0.5;
        }
        @keyframes neonRotate {
            0% { background-position: 0 0; }
            100% { background-position: 400px 400px; }
        }
        .title {
            text-align: center;
            color: #ff00ff;
            font-size: 24px;
            margin-bottom: 8px;
            text-shadow: 0 0 5px #ff00ff, 0 0 10px #ff00ff, 0 0 15px #00ffff;
            letter-spacing: 2px;
        }
        .sub-title {
            text-align: center;
            color: #00ffff;
            font-size: 14px;
            margin-bottom: 20px;
            text-shadow: 0 0 3px #00ffff;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-label {
            display: block;
            color: #00ffff;
            font-size: 14px;
            margin-bottom: 5px;
            text-shadow: 0 0 2px #00ffff;
        }
        .input-box {
            width: 100%;
            height: 45px;
            background-color: #1a0a2c;
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 0 15px;
            color: #fff;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }
        .input-box:focus {
            border-color: #ff00ff;
            box-shadow: 0 0 8px #ff00ff;
        }
        .submit-btn {
            width: 100%;
            height: 50px;
            background: linear-gradient(90deg, #ff00ff, #00ffff);
            border: none;
            border-radius: 10px;
            color: #000;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
            text-shadow: 0 0 2px #fff;
        }
        .submit-btn:hover {
            box-shadow: 0 0 10px #ff00ff, 0 0 20px #00ffff;
            transform: scale(1.02);
        }
        .submit-btn:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .tab-container {
            display: flex;
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #00ffff;
        }
        .tab-btn {
            flex: 1;
            height: 40px;
            line-height: 40px;
            text-align: center;
            background-color: #1a0a2c;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab-btn.active {
            background: linear-gradient(90deg, #ff00ff, #00ffff);
            color: #000;
            font-weight: bold;
        }
        .module {
            display: none;
        }
        .module.active {
            display: block;
        }
        .status-switch-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .status-btn {
            flex: 1;
            height: 45px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .status-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 8px currentColor;
        }
        .order-item {
            background-color: #1a0a2c;
            border: 1px solid #00ffff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            color: #fff;
        }
        .order-no {
            color: #ff00ff;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .order-info {
            font-size: 14px;
            margin-bottom: 3px;
        }
        .order-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 5px;
        }
        .status-wait {
            background-color: #ffcc00;
            color: #000;
        }
        .status-doing {
            background-color: #0099ff;
            color: #fff;
        }
        .status-finished {
            background-color: #00cc66;
            color: #fff;
        }
        .chat-container {
            background-color: #1a0a2c;
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 10px;
            margin-top: 15px;
        }
        .chat-list {
            height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        .chat-message {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 8px;
        }
        .chat-self {
            background-color: #ff00ff33;
            text-align: right;
        }
        .chat-other {
            background-color: #00ffff33;
            text-align: left;
        }
        .chat-sender {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 3px;
        }
        .chat-content {
            font-size: 14px;
            color: #fff;
        }
        .chat-input-group {
            display: flex;
            gap: 10px;
        }
        .chat-input {
            flex: 1;
            height: 40px;
            background-color: #2a1a3c;
            border: 1px solid #00ffff;
            border-radius: 8px;
            padding: 0 10px;
            color: #fff;
            outline: none;
        }
        .chat-send-btn {
            width: 80px;
            height: 40px;
            background: linear-gradient(90deg, #ff00ff, #00ffff);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
        }
        .empty-tip {
            text-align: center;
            color: #999;
            padding: 20px;
            font-size: 14px;
        }
        .admin-submodule {
            display: none;
            margin-top: 15px;
        }
        .admin-submodule.active {
            display: block;
        }
        .admin-tab {
            padding: 8px 15px;
            background-color: #1a0a2c;
            border: 1px solid #00ffff;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        .admin-tab.active {
            background: #ff00ff;
            color: #000;
            font-weight: bold;
        }
        .qrcode-container {
            text-align: center;
            margin: 20px 0;
        }
        .qrcode-img {
            width: 180px;
            height: 180px;
            border: 2px solid #00ffff;
            border-radius: 8px;
            box-shadow: 0 0 10px #00ffff;
        }
        .qrcode-tip {
            color: #00ffff;
            font-size: 12px;
            margin-top: 8px;
            text-shadow: 0 0 2px #00ffff;
        }
    </style>
</head>
<body>
    <div class="main-container" id="loginContainer">
        <h1 class="title">好困俱乐部</h1>
        <h2 class="sub-title">陪玩端管理系统</h2>
        
        <div class="input-group">
            <label class="input-label">陪玩账号/管理员账号</label>
            <input type="text" class="input-box" id="playerAccount" placeholder="输入账号（如陪玩1/管理员）">
        </div>
        
        <div class="input-group">
            <label class="input-label">登录密码</label>
            <input type="password" class="input-box" id="playerPwd" placeholder="输入密码">
        </div>
        
        <button class="submit-btn" onclick="playerLogin()">登录陪玩系统</button>

        <!-- 陪玩端专属二维码 -->
        <div class="qrcode-container">
            <h3 class="sub-title">扫码进入陪玩端</h3>
            <img src="https://api.2dcode.biz/v1/create-qr-code?data=https://y5z2j0.github.io/haokun-club/player.html&size=180x180&fgcolor=%23ff00ff&bgcolor=%230a0218&margin=10&logo=https://via.placeholder.com/35?text=陪玩端&logofgcolor=%2300ffff&logobgcolor=transparent" 
                 alt="陪玩端二维码" class="qrcode-img">
            <p class="qrcode-tip">陪玩默认密码：陪玩1→pw000001 ... 陪玩50→pw000050</p>
        </div>
    </div>

    <div class="main-container" id="playerMain" style="display: none; height: 90vh; overflow-y: auto;">
        <h1 class="title">陪玩工作台</h1>
        <h2 class="sub-title" id="playerNameShow"></h2>

        <!-- 状态切换按钮 -->
        <div class="status-switch-group">
            <button class="status-btn" onclick="switchPlayerStatus('online')" style="background:#00ff00;color:#000;">在线</button>
            <button class="status-btn" onclick="switchPlayerStatus('busy')" style="background:#ff6600;color:#fff;">接单中</button>
            <button class="status-btn" onclick="switchPlayerStatus('offline')" style="background:#888;color:#fff;">不在线</button>
        </div>

        <div class="tab-container">
            <div class="tab-btn active" onclick="switchTab('order')">订单中心</div>
            <div class="tab-btn" onclick="switchTab('chat')">聊天消息</div>
            <div class="tab-btn" onclick="switchTab('balance')">我的收益</div>
        </div>

        <!-- 订单模块 -->
        <div class="module active" id="orderModule">
            <div class="input-group">
                <input type="text" class="input-box" id="orderSearch" placeholder="输入订单号搜索">
            </div>
            <button class="submit-btn" onclick="searchPlayerOrder()">搜索订单</button>
            <div id="playerOrderList" style="margin-top:15px;"></div>
        </div>

        <!-- 聊天模块 -->
        <div class="module" id="chatModule">
            <div class="input-group">
                <select class="input-box" id="playerChatSelect">
                    <option value="">选择订单进行聊天</option>
                </select>
            </div>
            <div class="chat-container">
                <div class="chat-list" id="playerChatList"></div>
                <div class="chat-input-group">
                    <input type="text" class="chat-input" id="playerChatInput" placeholder="输入消息..." disabled>
                    <button class="chat-send-btn" onclick="sendPlayerChat()" disabled>发送</button>
                </div>
            </div>
        </div>

        <!-- 收益模块 -->
        <div class="module" id="balanceModule">
            <div class="input-group">
                <label class="input-label">当前余额（元）</label>
                <input type="text" class="input-box" id="playerBalance" readonly>
            </div>
            <div class="input-group">
                <label class="input-label">提款金额（元）</label>
                <input type="number" class="input-box" id="withdrawAmount" placeholder="输入提款金额">
            </div>
            <button class="submit-btn" onclick="submitWithdraw()">提交提款申请</button>
            <div id="withdrawRecord" style="margin-top:15px;"></div>
        </div>

        <button class="submit-btn" style="margin-top:20px;" onclick="playerLogout()">退出登录</button>
    </div>

    <div class="main-container" id="adminMain" style="display: none; height: 90vh; overflow-y: auto;">
        <h1 class="title">管理员后台</h1>
        <h2 class="sub-title">系统总管理面板</h2>

        <div style="display: flex; flex-wrap: wrap; margin-bottom:15px;">
            <div class="admin-tab active" onclick="switchAdminSubmodule('playerManage')">陪玩管理</div>
            <div class="admin-tab" onclick="switchAdminSubmodule('orderManage')">订单管理</div>
            <div class="admin-tab" onclick="switchAdminSubmodule('violationManage')">违规处理</div>
            <div class="admin-tab" onclick="switchAdminSubmodule('notifyManage')">消息通知</div>
        </div>

        <!-- 陪玩管理子模块 -->
        <div class="admin-submodule active" id="playerManageSubmodule">
            <div class="input-group">
                <label class="input-label">选择陪玩</label>
                <select class="input-box" id="adminPlayerSelect"></select>
            </div>
            <div class="input-group">
                <label class="input-label">修改密码</label>
                <input type="text" class="input-box" id="newPlayerPwd" placeholder="输入新密码">
            </div>
            <button class="submit-btn" onclick="updatePlayerPassword()">修改密码</button>
            
            <div class="input-group" style="margin-top:15px;">
                <label class="input-label">修改名称</label>
                <input type="text" class="input-box" id="newPlayerName" placeholder="输入新名称">
            </div>
            <button class="submit-btn" onclick="updatePlayerNickname()">修改名称</button>
            
            <button class="submit-btn" style="margin-top:15px;" onclick="updatePlayerStatusByAdmin()">切换在线状态</button>
        </div>

        <!-- 订单管理子模块 -->
        <div class="admin-submodule" id="orderManageSubmodule">
            <div class="input-group">
                <label class="input-label">订单号查询</label>
                <input type="text" class="input-box" id="adminOrderQuery" placeholder="输入订单号">
            </div>
            <button class="submit-btn" onclick="queryOrderByAdmin()">查询订单</button>
            <div id="adminOrderList" style="margin-top:15px;"></div>
        </div>

        <!-- 违规处理子模块 -->
        <div class="admin-submodule" id="violationManageSubmodule">
            <div class="input-group">
                <label class="input-label">选择违规陪玩</label>
                <select class="input-box" id="violationPlayerSelect"></select>
            </div>
            <div class="input-group">
                <label class="input-label">违规原因</label>
                <input type="text" class="input-box" id="violationReason" placeholder="输入违规原因">
            </div>
            <button class="submit-btn" onclick="warnPlayerByAdmin()">警告处理</button>
            <button class="submit-btn" style="margin-top:10px;" onclick="finePlayerByAdmin()">罚款处理（10元）</button>
        </div>

        <!-- 消息通知子模块 -->
        <div class="admin-submodule" id="notifyManageSubmodule">
            <div class="input-group">
                <label class="input-label">发送通知内容</label>
                <input type="text" class="input-box" id="notifyContent" placeholder="输入通知内容">
            </div>
            <button class="submit-btn" onclick="sendAdminAllNotify()">发送给所有陪玩</button>
            <div id="notifyRecord" style="margin-top:15px;"></div>
        </div>

        <button class="submit-btn" style="margin-top:20px;" onclick="adminLogout()">退出管理员</button>
    </div>

    <script>
        // 全局常量
        const STORAGE_KEYS = {
            playerList: 'hk_player_list',
            orderList: 'hk_order_list',
            playerBalances: 'hk_player_balances',
            playerViolations: 'hk_player_violations',
            withdrawRecords: 'hk_withdraw_records',
            notifyRecords: 'hk_notify_records'
        };
        const FORBIDDEN_WORDS = ['违规', '作弊', '辱骂', '欺诈'];
        const VIOLATION_FINE = 10; // 罚款金额

        // 全局变量
        let loginPlayer = null;
        let currentChatOrder = '';
        let playerList = [];
        let orderList = [];
        let playerBalances = {};
        let playerViolations = {};
        let withdrawRecords = [];
        let notifyRecords = [];
        let statusWebSocket = null;

        // 初始化页面
        window.onload = function() {
            initData();
            initStatusWebSocket();
        };

        // 初始化数据
        function initData() {
            // 初始化陪玩列表
            if (!localStorage.getItem(STORAGE_KEYS.playerList)) {
                playerList = [];
                for (let i = 1; i <= 50; i++) {
                    playerList.push({
                        id: `player_${i}`,
                        name: `陪玩${i}`,
                        account: `陪玩${i}`,
                        password: `pw${String(i).padStart(6, '0')}`,
                        avatar: `https://via.placeholder.com/64?text=陪玩${i}`,
                        gameType: i % 3 === 0 ? '4队技术服务' : i % 3 === 1 ? '4队娱乐服务' : '摸金/古城极限',
                        status: 'offline',
                        unreadOrders: 0
                    });
                }
                // 添加管理员
                playerList.push({
                    id: 'admin',
                    name: '管理员',
                    account: '管理员',
                    password: 'admin123456',
                    avatar: 'https://via.placeholder.com/64?text=管理员',
                    gameType: '系统管理',
                    status: 'online',
                    unreadOrders: 0
                });
                localStorage.setItem(STORAGE_KEYS.playerList, JSON.stringify(playerList));
            } else {
                playerList = JSON.parse(localStorage.getItem(STORAGE_KEYS.playerList));
            }

            // 初始化其他数据
            if (!localStorage.getItem(STORAGE_KEYS.orderList)) orderList = [];
            else orderList = JSON.parse(localStorage.getItem(STORAGE_KEYS.orderList));

            if (!localStorage.getItem(STORAGE_KEYS.playerBalances)) playerBalances = {};
            else playerBalances = JSON.parse(localStorage.getItem(STORAGE_KEYS.playerBalances));

            if (!localStorage.getItem(STORAGE_KEYS.playerViolations)) {
                playerViolations = {};
                playerList.forEach(p => {
                    playerViolations[p.id] = { count: 0, reasons: [] };
                });
            } else {
                playerViolations = JSON.parse(localStorage.getItem(STORAGE_KEYS.playerViolations));
            }

            if (!localStorage.getItem(STORAGE_KEYS.withdrawRecords)) withdrawRecords = [];
            else withdrawRecords = JSON.parse(localStorage.getItem(STORAGE_KEYS.withdrawRecords));

            if (!localStorage.getItem(STORAGE_KEYS.notifyRecords)) notifyRecords = [];
            else notifyRecords = JSON.parse(localStorage.getItem(STORAGE_KEYS.notifyRecords));

            // 初始化管理员下拉框
            initAdminSelects();
        }

        // 初始化实时状态WebSocket（模拟）
        function initStatusWebSocket() {
            if (statusWebSocket) clearInterval(statusWebSocket);
            statusWebSocket = setInterval(() => {
                syncPlayerStatus();
            }, 3000);
        }

        // 同步陪玩状态
        function syncPlayerStatus() {
            const storedPlayers = JSON.parse(localStorage.getItem(STORAGE_KEYS.playerList));
            if (storedPlayers) {
                playerList.forEach((player, index) => {
                    if (player.status !== storedPlayers[index].status) {
                        player.status = storedPlayers[index].status;
                    }
                });
                saveDataToLocalStorage();
            }
        }

        // 陪玩登录
        function playerLogin() {
            const account = document.getElementById('playerAccount').value.trim();
            const pwd = document.getElementById('playerPwd').value.trim();

            if (!account || !pwd) {
                alert('请输入账号和密码！');
                return;
            }

            const targetPlayer = playerList.find(p => p.account === account && p.password === pwd);
            if (!targetPlayer) {
                alert('账号或密码错误！');
                return;
            }

            loginPlayer = targetPlayer;

            if (targetPlayer.id === 'admin') {
                // 管理员登录
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('playerMain').style.display = 'none';
                document.getElementById('adminMain').style.display = 'block';
                initAdminSelects();
            } else {
                // 陪玩登录
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('adminMain').style.display = 'none';
                document.getElementById('playerMain').style.display = 'block';
                document.getElementById('playerNameShow').innerText = `当前登录：${targetPlayer.name}`;
                
                // 初始化订单和余额
                renderPlayerOrderList();
                initPlayerChatSelect();
                renderPlayerBalance();
                renderWithdrawRecord();
            }
        }

        // 切换陪玩状态
        function switchPlayerStatus(status) {
            if (!loginPlayer) return alert('请先登录');
            loginPlayer.status = status;
            
            const storedPlayers = JSON.parse(localStorage.getItem(STORAGE_KEYS.playerList));
            const playerIndex = storedPlayers.findIndex(p => p.id === loginPlayer.id);
            if (playerIndex !== -1) {
                storedPlayers[playerIndex].status = status;
                localStorage.setItem(STORAGE_KEYS.playerList, JSON.stringify(storedPlayers));
            }
            
            alert(`状态已切换为：${status === 'online' ? '在线' : status === 'busy' ? '接单中' : '不在线'}`);
        }

        // 切换标签页
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.module').forEach(module => module.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`${tabId}Module`).classList.add('active');
        }

        // 渲染陪玩订单列表
        function renderPlayerOrderList() {
            const searchVal = document.getElementById('orderSearch').value.trim().toLowerCase();
            let filteredOrders = orderList.filter(o => o.playerId === loginPlayer.id);
            if (searchVal) {
                filteredOrders = filteredOrders.filter(o => o.orderNo.includes(searchVal));
            }

            let html = '';
            if (filteredOrders.length === 0) {
                html = '<div class="empty-tip">暂无订单记录</div>';
            } else {
                filteredOrders.forEach(order => {
                    html += `<div class="order-item">
                        <div class="order-no">订单号：${order.orderNo}</div>
                        <div class="order-info">服务类型：${order.service}</div>
                        <div class="order-info">老板联系方式：${order.bossContact}</div>
                        <div class="order-status ${order.status === '待接单' ? 'status-wait' : order.status === '进行中' ? 'status-doing' : 'status-finished'}">
                            ${order.status}
                        </div>
                    </div>`;
                });
            }
            document.getElementById('playerOrderList').innerHTML = html;
        }

        // 搜索陪玩订单
        function searchPlayerOrder() {
            renderPlayerOrderList();
        }

        // 初始化聊天订单选择
        function initPlayerChatSelect() {
            const select = document.getElementById('playerChatSelect');
            select.innerHTML = '<option value="">选择订单进行聊天</option>';
            
            const playerOrders = orderList.filter(o => o.playerId === loginPlayer.id);
            playerOrders.forEach(order => {
                select.innerHTML += `<option value="${order.orderNo}">${order.orderNo} - ${order.service}</option>`;
            });

            // 绑定选择事件
            select.addEventListener('change', function() {
                const orderNo = this.value;
                if (!orderNo) {
                    document.getElementById('playerChatInput').disabled = true;
                    document.querySelector('.chat-send-btn').disabled = true;
                    currentChatOrder = '';
                    return;
                }
                currentChatOrder = orderNo;
                const order = orderList.find(o => o.orderNo === orderNo);
                if (order) {
                    document.getElementById('playerChatInput').disabled = false;
                    document.querySelector('.chat-send-btn').disabled = false;
                    renderChatRecords(order.chatRecords || []);
                }
            });
        }

        // 渲染聊天记录
        function renderChatRecords(records) {
            const chatList = document.getElementById('playerChatList');
            if (!records || records.length === 0) {
                chatList.innerHTML = '<div class="empty-tip">暂无聊天记录</div>';
                return;
            }
            let html = '';
            records.forEach(msg => {
                const isSelf = msg.sender === 'player';
                html += `<div class="chat-message ${isSelf ? 'chat-self' : 'chat-other'}">
                    <div class="chat-sender">${msg.senderName} ${msg.time}</div>
                    <div class="chat-content">${msg.content}</div>
                </div>`;
            });
            chatList.innerHTML = html;
            chatList.scrollTop = chatList.scrollHeight;
        }

        // 发送陪玩聊天消息
        function sendPlayerChat() {
            const content = document.getElementById('playerChatInput').value.trim();
            if (!content) return alert('请输入消息内容');
            if (checkForbiddenWords(content)) return alert('消息包含违规词汇，禁止发送');

            const order = orderList.find(o => o.orderNo === currentChatOrder);
            if (!order) return alert('订单不存在');

            if (!order.chatRecords) order.chatRecords = [];
            order.chatRecords.push({
                sender: 'player',
                senderName: loginPlayer.name,
                content: content,
                time: new Date().toLocaleString()
            });

            document.getElementById('playerChatInput').value = '';
            renderChatRecords(order.chatRecords);
            saveDataToLocalStorage();
        }

        // 渲染陪玩余额
        function renderPlayerBalance() {
            if (!playerBalances[loginPlayer.id]) {
                playerBalances[loginPlayer.id] = '0.00';
            }
            document.getElementById('playerBalance').value = playerBalances[loginPlayer.id];
        }

        // 提交提款申请
        function submitWithdraw() {
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const balance = parseFloat(playerBalances[loginPlayer.id] || 0);

            if (isNaN(amount) || amount <= 0) return alert('请输入有效的提款金额');
            if (amount > balance) return alert('提款金额不能超过当前余额');

            const withdrawRecord = {
                playerId: loginPlayer.id,
                playerName: loginPlayer.name,
                amount: amount.toFixed(2),
                time: new Date().toLocaleString(),
                status: '待审核'
            };

            withdrawRecords.push(withdrawRecord);
            playerBalances[loginPlayer.id] = (balance - amount).toFixed(2);

            document.getElementById('withdrawAmount').value = '';
            renderPlayerBalance();
            renderWithdrawRecord();
            saveDataToLocalStorage();
            alert('提款申请已提交，等待管理员审核');
        }

        // 渲染提款记录
        function renderWithdrawRecord() {
            const playerWithdraws = withdrawRecords.filter(w => w.playerId === loginPlayer.id);
            let html = '';
            if (playerWithdraws.length === 0) {
                html = '<div class="empty-tip">暂无提款记录</div>';
            } else {
                playerWithdraws.forEach(record => {
                    html += `<div class="order-item">
                        <div class="order-no">提款金额：${record.amount}元</div>
                        <div class="order-info">申请时间：${record.time}</div>
                        <div class="order-status ${record.status === '待审核' ? 'status-wait' : 'status-finished'}">
                            ${record.status}
                        </div>
                    </div>`;
                });
            }
            document.getElementById('withdrawRecord').innerHTML = html;
        }

        // 陪玩退出登录
        function playerLogout() {
            loginPlayer = null;
            document.getElementById('playerMain').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('playerAccount').value = '';
            document.getElementById('playerPwd').value = '';
        }

        // 管理员切换子模块
        function switchAdminSubmodule(submoduleId) {
            document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.admin-submodule').forEach(module => module.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(submoduleId + 'Submodule').classList.add('active');
        }

        // 初始化管理员下拉框
        function initAdminSelects() {
            let playerHtml = '<option value="">请选择要管理的陪玩</option>';
            let violationHtml = '<option value="">请选择违规陪玩</option>';
            playerList.forEach(p => {
                if (p.id !== 'admin') {
                    playerHtml += `<option value="${p.id}">${p.name}</option>`;
                    violationHtml += `<option value="${p.id}">${p.name}（违规${playerViolations[p.id].count}次）</option>`;
                }
            });
            document.getElementById('adminPlayerSelect').innerHTML = playerHtml;
            document.getElementById('violationPlayerSelect').innerHTML = violationHtml;
        }

        // 管理员修改陪玩密码
        function updatePlayerPassword() {
            const playerId = document.getElementById('adminPlayerSelect').value;
            const newPwd = document.getElementById('newPlayerPwd').value.trim();
            if (!playerId || !newPwd) {
                alert('请选择陪玩并输入新密码');
                return;
            }
            const targetPlayer = playerList.find(p => p.id === playerId);
            targetPlayer.password = newPwd;
            saveDataToLocalStorage();
            alert(`✅ 陪玩【${targetPlayer.name}】密码已修改为：${newPwd}`);
        }

        // 管理员修改陪玩名称
        function updatePlayerNickname() {
            const playerId = document.getElementById('adminPlayerSelect').value;
            const newName = document.getElementById('newPlayerName').value.trim();
            if (!playerId || !newName) {
                alert('请选择陪玩并输入新名称');
                return;
            }
            const targetPlayer = playerList.find(p => p.id === playerId);
            targetPlayer.name = newName;
            targetPlayer.account = newName;
            saveDataToLocalStorage();
            alert(`✅ 陪玩名称已修改为：${newName}`);
            initAdminSelects();
        }

        // 管理员切换陪玩状态
        function updatePlayerStatusByAdmin() {
            const playerId = document.getElementById('adminPlayerSelect').value;
            if (!playerId) {
                alert('请选择陪玩');
                return;
            }
            const targetPlayer = playerList.find(p => p.id === playerId);
            targetPlayer.status = targetPlayer.status === 'online' ? 'offline' : 'online';
            saveDataToLocalStorage();
            alert(`✅ 陪玩【${targetPlayer.name}】状态已切换为：${targetPlayer.status === 'online' ? '在线' : '不在线'}`);
        }

        // 管理员警告陪玩
        function warnPlayerByAdmin() {
            const playerId = document.getElementById('violationPlayerSelect').value;
            const reason = document.getElementById('violationReason').value.trim();
            if (!playerId || !reason) {
                alert('请选择陪玩并输入违规原因');
                return;
            }
            playerViolations[playerId].count++;
            playerViolations[playerId].reasons.push(reason);
            saveDataToLocalStorage();
            alert(`✅ 已警告陪玩，违规原因：${reason}`);
            document.getElementById('violationReason').value = '';
            initAdminSelects();
        }

        // 管理员罚款陪玩
        function finePlayerByAdmin() {
            const playerId = document.getElementById('violationPlayerSelect').value;
            const reason = document.getElementById('violationReason').value.trim();
            if (!playerId || !reason) {
                alert('请选择陪玩并输入违规原因');
                return;
            }
            playerViolations[playerId].count++;
            playerViolations[playerId].reasons.push(reason);
            playerBalances[playerId] = Math.max(0, parseFloat(playerBalances[playerId] || 0) - VIOLATION_FINE).toFixed(2);
            saveDataToLocalStorage();
            alert(`✅ 已对陪玩罚款${VIOLATION_FINE}元，违规原因：${reason}`);
            document.getElementById('violationReason').value = '';
            initAdminSelects();
        }

        // 管理员查询订单
        function queryOrderByAdmin() {
            const orderNo = document.getElementById('adminOrderQuery').value.trim();
            if (!orderNo) {
                alert('请输入订单号');
                return;
            }
            const order = orderList.find(o => o.orderNo === orderNo);
            if (!order) {
                document.getElementById('adminOrderList').innerHTML = '<div class="empty-tip">未找到该订单</div>';
                return;
            }
            const html = `<div class="order-item">
                <div class="order-no">订单号：${order.orderNo}</div>
                <div class="order-info">服务：${order.service}</div>
                <div class="order-info">老板：${order.bossContact}</div>
                <div class="order-info">陪玩：${order.playerName || '未分配'}</div>
                <div class="order-status ${order.status === '待接单' ? 'status-wait' : order.status === '进行中' ? 'status-doing' : 'status-finished'}">
                    ${order.status}
                </div>
            </div>`;
            document.getElementById('adminOrderList').innerHTML = html;
        }

        // 管理员发送通知
        function sendAdminAllNotify() {
            const content = document.getElementById('notifyContent').value.trim();
            if (!content) return alert('请输入通知内容');
            if (checkForbiddenWords(content)) return alert('通知包含违规词汇，禁止发送');

            const notifyRecord = {
                content: content,
                time: new Date().toLocaleString(),
                sender: '管理员'
            };
            notifyRecords.push(notifyRecord);
            saveDataToLocalStorage();

            document.getElementById('notifyContent').value = '';
            alert('通知已发送给所有陪玩');
            sendAdminNotification(content);
        }

        // 管理员退出
        function adminLogout() {
            loginPlayer = null;
            document.getElementById('adminMain').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('playerAccount').value = '';
            document.getElementById('playerPwd').value = '';
        }

        // 工具函数
        function saveDataToLocalStorage() {
            localStorage.setItem(STORAGE_KEYS.playerList, JSON.stringify(playerList));
            localStorage.setItem(STORAGE_KEYS.orderList, JSON.stringify(orderList));
            localStorage.setItem(STORAGE_KEYS.playerBalances, JSON.stringify(playerBalances));
            localStorage.setItem(STORAGE_KEYS.playerViolations, JSON.stringify(playerViolations));
            localStorage.setItem(STORAGE_KEYS.withdrawRecords, JSON.stringify(withdrawRecords));
            localStorage.setItem(STORAGE_KEYS.notifyRecords, JSON.stringify(notifyRecords));
        }

        function generateOrderNo() {
            return 'HK' + Date.now() + Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        }

        function sendAdminNotification(content) {
            console.log('管理员通知：', content);
        }

        function checkForbiddenWords(content) {
            return FORBIDDEN_WORDS.some(word => content.includes(word));
        }
    </script>
</body>
</html>
